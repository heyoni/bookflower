{% extends 'base.html' %}

{% block title %}{{ book.book_title }} - ì±…ë°”ë¼ê¸°{% endblock %}

{% block content %}
<div class="book-detail-container">
    <!-- ì±… ì •ë³´ í—¤ë” -->
    <div class="book-header">
        <h1>{{ book.book_title }}</h1>
        <p class="book-author">{{ book.book_author }}</p>

        <div class="book-progress">
            <div class="progress-bar" data-percent="{{ progress_percent }}">
                <div class="progress-fill"></div>
            </div>
            <div class="progress-text">{{ book.current_page }}/{{ book.total_pages }}í˜ì´ì§€</div>
        </div>

        <div class="book-status-row">
            <div class="book-status">
                {% if book.status == 'reading' %}
                    <span class="status-reading">ğŸ“– ì½ëŠ” ì¤‘</span>
                {% elif book.status == 'completed' %}
                    <span class="status-completed">âœ… ì™„ë…</span>
                {% elif book.status == 'paused' %}
                    <span class="status-paused">â¸ï¸ ì¼ì‹œì •ì§€</span>
                {% elif book.status == 'dropped' %}
                    <span class="status-dropped">âŒ ì¤‘ë‹¨</span>
                {% endif %}
            </div>

            <!-- ì±… ì‚­ì œ ë²„íŠ¼ -->
            <div class="book-actions">
                <form method="post" action="{% url 'reading:delete_book' book.id %}"
                      style="display: inline;"
                      onsubmit="return confirm('ì •ë§ë¡œ ì´ ì±…ì„ ë‚´ ì±…ì¥ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì±…ê³¼ ê´€ë ¨ëœ ëª¨ë“  ë…¸íŠ¸ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.');">
                    {% csrf_token %}
                    <button type="submit" class="btn-delete-book">
                        ğŸ—‘ï¸ ì‚­ì œí•˜ê¸°
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- ë…ì„œ ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸ -->
    <div class="progress-update-card">
        <h3>ğŸ“Š ë…ì„œ ì§„í–‰ìƒí™©</h3>
        <form method="post" action="{% url 'reading:update_with_note' book.id %}">
            {% csrf_token %}

            <!-- ë©”ëª¨ ì…ë ¥ ì˜ì—­ (ê¸°ë³¸ ìˆ¨ê¹€) -->
            <div id="memoSection" class="memo-section" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ë©”ëª¨í•  í˜ì´ì§€</label>
                        <input type="number" name="note_page" value="{{ book.current_page }}"
                               min="1" max="{{ book.total_pages }}" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ“ ë…ì„œ ë©”ëª¨</label>
                    <textarea name="note_content" class="form-textarea"
                              placeholder="ì´ í˜ì´ì§€ë¥¼ ì½ìœ¼ë©´ì„œ ëŠë‚€ ì ì´ë‚˜ ì¤‘ìš”í•œ ë‚´ìš©ì„ ê¸°ë¡í•´ë³´ì„¸ìš”..."></textarea>
                </div>
            </div>

            <!-- ì§„í–‰ìƒí™© ì…ë ¥ -->
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">í˜„ì¬ ì½ì€ í˜ì´ì§€</label>
                    <input type="number" name="current_page" value="{{ book.current_page }}"
                           min="0" max="{{ book.total_pages }}" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ìƒíƒœ</label>
                    <select name="status" class="form-input">
                        <option value="reading" {% if book.status == 'reading' %}selected{% endif %}>ì½ëŠ” ì¤‘</option>
                        <option value="completed" {% if book.status == 'completed' %}selected{% endif %}>ì™„ë…</option>
                        <option value="paused" {% if book.status == 'paused' %}selected{% endif %}>ì¼ì‹œì •ì§€</option>
                        <option value="dropped" {% if book.status == 'dropped' %}selected{% endif %}>ì¤‘ë‹¨</option>
                    </select>
                </div>
            </div>

            <!-- ë²„íŠ¼ë“¤ -->
            <div class="button-group">
                <button type="button" class="btn btn-secondary btn-memo" onclick="toggleMemo()">
                    ğŸ“ ë©”ëª¨ ì¶”ê°€
                </button>
                <button type="submit" class="btn btn-primary">ğŸ’¾ ì§„í–‰ìƒí™© ì €ì¥</button>
            </div>
        </form>
    </div>

    <!-- ê¸°ì¡´ ë…¸íŠ¸ ëª©ë¡ -->
    <div class="notes-section">
        <h3>ğŸ“– ë‚´ ë…ì„œ ë…¸íŠ¸ ({{ notes.count }}ê°œ)</h3>

        {% if notes %}
        <div class="notes-list">
            {% for note in notes %}
            <div class="note-item">
                <div class="note-header">
                    <span class="note-page">ğŸ“„ {{ note.page_number }}í˜ì´ì§€</span>
                    <span class="note-date">{{ note.created_at|date:"nì›” jì¼" }}</span>
                </div>
                <div class="note-content">
                    {{ note.note_content|linebreaks }}
                </div>
                <div class="note-actions">
                    <form method="post" action="{% url 'reading:delete_note' book.id note.id %}"
                          style="display: inline;" onsubmit="return confirm('ì´ ë…¸íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                        {% csrf_token %}
                        <button type="submit" class="btn-delete">
                            <i class="fas fa-trash"></i> ì‚­ì œ
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-notes">
            <div class="empty-icon">
                <i class="fas fa-sticky-note"></i>
            </div>
            <p>ì•„ì§ ì‘ì„±í•œ ë…¸íŠ¸ê°€ ì—†ì–´ìš”.<br>ì±…ì„ ì½ìœ¼ë©´ì„œ ëŠë‚€ ì ì„ ê¸°ë¡í•´ë³´ì„¸ìš”!</p>
        </div>
        {% endif %}
    </div>

    <!-- ë…í›„ê° ì„¹ì…˜ -->
    {% if has_review %}
    <div class="review-section">
        <h3>âœï¸ ë‚´ ë…í›„ê°</h3>
        <p>AIê°€ ìƒì„±í•œ ë…í›„ê°ì„ ë³´ê±°ë‚˜ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <div class="review-actions">
            <a href="{% url 'chat:view_review' book.id %}" class="btn btn-primary btn-review">
                ğŸ“– ë…í›„ê° ë³´ê¸°
            </a>
            <a href="{% url 'chat:edit_review' book.id %}" class="btn btn-secondary btn-review">
                âœï¸ ë…í›„ê° ìˆ˜ì •
            </a>
            <form method="post" action="{% url 'chat:delete_review' book.id %}"
                  style="display: inline;"
                  onsubmit="return confirm('ì •ë§ë¡œ ë…í›„ê°ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger btn-review">
                    ğŸ—‘ï¸ ë…í›„ê° ì‚­ì œ
                </button>
            </form>
        </div>
    </div>
    {% elif notes %}
    <div class="review-section">
        <h3>âœï¸ AI ë…í›„ê° ìƒì„±</h3>
        <p>ì‘ì„±í•œ ë…¸íŠ¸ë“¤ì„ ë°”íƒ•ìœ¼ë¡œ AIê°€ ê°œì¸ì ì´ê³  ì§„ì†”í•œ ë…í›„ê°ì„ ìƒì„±í•´ë“œë¦½ë‹ˆë‹¤.</p>
        <a href="{% url 'chat:generate_review' book.id %}" class="btn btn-secondary btn-full">ğŸ¤– AI ë…í›„ê° ìƒì„±í•˜ê¸°</a>
    </div>
    {% else %}
    <div class="review-section">
        <h3>âœï¸ AI ë…í›„ê° ìƒì„±</h3>
        <p>ë…ì„œ ë…¸íŠ¸ë¥¼ ë¨¼ì € ì‘ì„±í•˜ì‹œë©´ AIê°€ ë…í›„ê°ì„ ìƒì„±í•´ë“œë¦½ë‹ˆë‹¤.</p>
        <div class="btn btn-secondary btn-full disabled">ğŸ“ ë…ì„œ ë…¸íŠ¸ë¥¼ ë¨¼ì € ì‘ì„±í•´ì£¼ì„¸ìš”</div>
    </div>
    {% endif %}
</div>

{% block extra_js %}
<script>
function toggleMemo() {
    const memoSection = document.getElementById('memoSection');
    const memoButton = document.querySelector('.btn-memo');

    if (memoSection.style.display === 'none' || memoSection.style.display === '') {
        memoSection.style.display = 'block';
        memoButton.classList.add('active');
        memoButton.textContent = 'ğŸ“ ë©”ëª¨ ì·¨ì†Œ';
    } else {
        memoSection.style.display = 'none';
        memoButton.classList.remove('active');
        memoButton.textContent = 'ğŸ“ ë©”ëª¨ ì¶”ê°€';
        // ë©”ëª¨ í•„ë“œ ì´ˆê¸°í™”
        document.querySelector('textarea[name="note_content"]').value = '';
    }
}
</script>
{% endblock %}

{% block extra_css %}
<style>
.book-detail-container {
    max-width: 100%;
}

.book-header {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid #4CAF50;
}

.book-header h1 {
    font-size: 1.3rem;
    margin-bottom: 0.5rem;
    color: #333;
    line-height: 1.4;
}

.book-author {
    color: #666;
    margin-bottom: 1rem;
}

.book-progress {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.progress-bar {
    flex: 1;
    height: 10px;
    background: #e0e0e0;
    border-radius: 5px;
    margin-right: 1rem;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #8BC34A);
    transition: width 0.3s ease;
}

.progress-text {
    font-size: 0.9rem;
    color: #666;
    min-width: 80px;
    text-align: right;
    font-weight: 500;
}

.book-status-row {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 0.5rem;
}

.book-status {
    flex: 1;
}

.status-reading { color: #4CAF50; font-weight: 500; }
.status-completed { color: #2196F3; font-weight: 500; }
.status-paused { color: #FF9800; font-weight: 500; }
.status-dropped { color: #f44336; font-weight: 500; }

.progress-update-card,
.notes-section,
.review-section {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.memo-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
    border-left: 4px solid #FF9800;
    animation: slideDown 0.3s ease;
}

.button-group {
    display: flex;
    gap: 0.5rem;
}

.btn-memo {
    flex: 1;
    background: #FF9800;
    color: white;
    border: none;
    padding: 0.8rem 1.5rem;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    transition: background 0.2s;
}

.btn-memo:hover {
    background: #F57C00;
}

.btn-memo.active {
    background: #F57C00;
}

.btn-primary {
    flex: 2;
    background: #4CAF50;
    color: white;
    border: none;
    padding: 0.8rem 1.5rem;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    transition: background 0.2s;
}

.btn-primary:hover {
    background: #45a049;
}

@keyframes slideDown {
    from {
        opacity: 0;
        max-height: 0;
        padding: 0 1rem;
    }
    to {
        opacity: 1;
        max-height: 200px;
        padding: 1rem;
    }
}


.reading-update-card h3,
.notes-section h3,
.review-section h3 {
    margin-bottom: 1rem;
    color: #333;
    font-size: 1.1rem;
}

.form-row {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 1rem;
}

.notes-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.note-item {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    border-left: 3px solid #4CAF50;
}

.note-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.note-page {
    font-weight: 500;
    color: #4CAF50;
}

.note-date {
    font-size: 0.8rem;
    color: #999;
}

.note-content {
    color: #333;
    line-height: 1.6;
    margin-bottom: 0.5rem;
}

.note-actions {
    text-align: right;
}

.btn-delete {
    background: none;
    border: none;
    color: #f44336;
    font-size: 0.8rem;
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    transition: background 0.2s;
}

.btn-delete:hover {
    background: #ffebee;
}

.book-actions {
    flex-shrink: 0;
}

.btn-delete-book {
    background: none;
    color: #999;
    border: none;
    padding: 0;
    margin: 0;
    cursor: pointer;
    font-weight: 500;
    transition: color 0.2s;
    font-family: inherit;
    font-size: 0.85em;
    line-height: inherit;
}

.btn-delete-book:hover {
    color: #f44336;
}

.empty-notes {
    text-align: center;
    padding: 2rem;
    color: #666;
}

.empty-icon {
    font-size: 2rem;
    color: #ddd;
    margin-bottom: 1rem;
}

.review-section {
    border: 2px dashed #ddd;
    text-align: center;
}

.review-section p {
    color: #666;
    margin-bottom: 1rem;
}

.btn.disabled {
    background: #e0e0e0 !important;
    color: #999 !important;
    cursor: not-allowed !important;
}

.btn.disabled:hover {
    background: #e0e0e0 !important;
}

.review-actions {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.btn-review {
    flex: 1;
    min-width: 120px;
    padding: 0.75rem 1rem;
    text-align: center;
    font-size: 0.9rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
}

.btn-primary {
    background: #4CAF50;
    color: white;
}

.btn-primary:hover {
    background: #45a049;
    text-decoration: none;
    color: white;
}

.btn-danger {
    background: #f44336;
    color: white;
}

.btn-danger:hover {
    background: #d32f2f;
}

/* ëª¨ë°”ì¼ ìµœì í™” */
@media (max-width: 480px) {
    .form-row {
        grid-template-columns: 1fr;
    }

    .note-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
    }

    .book-header h1 {
        font-size: 1.2rem;
    }

    .review-actions {
        flex-direction: column;
    }

    .btn-review {
        min-width: auto;
    }
}
</style>
{% endblock %}
{% endblock %}